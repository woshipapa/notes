# 流水线

分解为**子过程**，子过程处理时间最好相当

![image-20231230131658029](C:\Users\papa\AppData\Roaming\Typora\typora-user-images\image-20231230131658029.png)

俩条流水线，就是设备更多了或者干活的人更多了，超标量流水线（时间+空间并行）

![image-20231230131120662](C:\Users\papa\AppData\Roaming\Typora\typora-user-images\image-20231230131120662.png)

![image-20231230131429843](C:\Users\papa\AppData\Roaming\Typora\typora-user-images\image-20231230131429843.png)

![image-20231230133101355](C:\Users\papa\AppData\Roaming\Typora\typora-user-images\image-20231230133101355.png)

锁存器保存上一个段的运行结果，给下一个段提供输入

流水线周期需要选择最慢的，每个流水线周期锁存器会有一定的延迟

跟水管一样，从一头进，一头出

![image-20231230135421932](C:\Users\papa\AppData\Roaming\Typora\typora-user-images\image-20231230135421932.png)

## 流水线的分类

按计算机系统的层次

如果流水线的各个段由不同的系统配合完成，就是宏/系统级流水线

如果是CPU内部的各个部件协同工作的就是处理器级流水线

部件级是具体某一个部件内部的

![image-20231230140139223](C:\Users\papa\AppData\Roaming\Typora\typora-user-images\image-20231230140139223.png)

按完成功能的强弱分类

单功能和多功能

![image-20231230140314222](C:\Users\papa\AppData\Roaming\Typora\typora-user-images\image-20231230140314222.png)

静态流水线和动态流水线的区别在于，是否在同一个时间内，不同的段进行的运算是否一致

![image-20231230140718485](C:\Users\papa\AppData\Roaming\Typora\typora-user-images\image-20231230140718485.png)

![image-20231230140800783](C:\Users\papa\AppData\Roaming\Typora\typora-user-images\image-20231230140800783.png)

![image-20231230141054991](C:\Users\papa\AppData\Roaming\Typora\typora-user-images\image-20231230141054991.png)

任务流入的顺序和流出的顺序

![image-20231230141203346](C:\Users\papa\AppData\Roaming\Typora\typora-user-images\image-20231230141203346.png)

### 指令流水线策略

能够并行独立处理，不存在依赖关系的就可以放入一个段中同时处理

指令深度越大，也就是分的级数越多，同时并行的指令越多（指令周期也更短，CPU频率会很高），当有大量指令的时候，平均时间会缩短，但是不能级数过多，否则出现条件跳转指令时，可能有大量的无效计算还需要很多级的重新恢复

![image-20231230151958561](C:\Users\papa\AppData\Roaming\Typora\typora-user-images\image-20231230151958561.png) 

![image-20231230152059626](C:\Users\papa\AppData\Roaming\Typora\typora-user-images\image-20231230152059626.png)

存在前后依赖关系的指令不能使用流水线并行处理，因为后者需要前者的结果，依赖于它

![image-20231230155252858](C:\Users\papa\AppData\Roaming\Typora\typora-user-images\image-20231230155252858.png)

多流水线可以每个流水线去同时的处理不同的指令

![image-20231230155506768](C:\Users\papa\AppData\Roaming\Typora\typora-user-images\image-20231230155506768.png)

# 相关

## 结构相关

指令重叠执行期间，对同一资源的访问导致冲突

解决办法：功能部件完全流水化，增加硬件资源

## 数据相关

通过流水线互锁器件进行依赖关系的检查，然后进行暂停等待

直通，在写入寄存器的同时通过专用数据通路传递给需要的部件，少一个时钟周期

编译器优化，在等待期间插入空指令或者没有依赖关系的指令

![image-20240108134333476](C:\Users\papa\AppData\Roaming\Typora\typora-user-images\image-20240108134333476.png)

## 控制相关

![image-20240108134622381](C:\Users\papa\AppData\Roaming\Typora\typora-user-images\image-20240108134622381.png)

预取分支目标就是在条件分支指令识别到后，把会跳转的目标指令也拿到流水线中，然后如果要跳转就可以立即执行

![image-20240108134836611](C:\Users\papa\AppData\Roaming\Typora\typora-user-images\image-20240108134836611.png)

多流，在遇到分支指令时，会执行俩条或者多条指令

![image-20240108135059991](C:\Users\papa\AppData\Roaming\Typora\typora-user-images\image-20240108135059991.png)

![image-20240108135538314](C:\Users\papa\AppData\Roaming\Typora\typora-user-images\image-20240108135538314.png)

# 分支预测

## 静态分支预测

![image-20240108140314792](C:\Users\papa\AppData\Roaming\Typora\typora-user-images\image-20240108140314792.png)

## 动态分支预测

![image-20240108141100141](C:\Users\papa\AppData\Roaming\Typora\typora-user-images\image-20240108141100141.png)

![image-20240108141105053](C:\Users\papa\AppData\Roaming\Typora\typora-user-images\image-20240108141105053.png)

# 延迟分支

就是不会在执行条件分支的同时去执行它后面的指令，因为可能因为转移而荒废，而是去执行其他不相关的指令，这些指令会被放入延迟槽中

延迟槽都是一个，且无论分支是否成功，都需要执行延迟槽中的指令。

总而言之，延迟槽的作用就是通过找与分支无关的指令（或者不影响分支运行的指令）去充分利用分支的空间，进而削弱预测分支的副作用，减少分支延迟。

就是避免预测失败导致的流水线气泡时间

![image-20240108141652718](C:\Users\papa\AppData\Roaming\Typora\typora-user-images\image-20240108141652718.png)
